<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAIA Widget Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        
        #console-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üîß SAIA Widget Debug Test</h1>
    
    <div class="debug-panel">
        <h2>üìä Loading Status</h2>
        <div id="script-status" class="status info">Loading widget script...</div>
        <div id="init-status" class="status info">Waiting for initialization...</div>
        <div id="widget-status" class="status info">Checking widget visibility...</div>
    </div>
    
    <div class="debug-panel">
        <h2>üîç Debug Information</h2>
        <p><strong>Script URL:</strong> <span id="script-url">http://127.0.0.1:8000/static/widget/js/saia-widget-loader.js</span></p>
        <p><strong>Company:</strong> <span id="company">wazen</span></p>
        <p><strong>Position:</strong> <span id="position">bottom-right</span></p>
        <p><strong>Theme:</strong> <span id="theme">wazen-blue</span></p>
    </div>
    
    <div class="debug-panel">
        <h2>üìù Console Output</h2>
        <div id="console-output"></div>
    </div>
    
    <div class="debug-panel">
        <h2>üß™ Manual Tests</h2>
        <button onclick="testWidgetExists()">Test Widget Exists</button>
        <button onclick="testWidgetVisible()">Test Widget Visible</button>
        <button onclick="testAPIConnection()">Test API Connection</button>
        <button onclick="forceShowWidget()">Force Show Widget</button>
    </div>

    <!-- SAIA Widget Integration -->
    <script src="http://127.0.0.1:8000/static/widget/js/saia-widget-loader.js" 
            data-company="wazen" 
            data-position="bottom-right"
            data-theme="wazen-blue"
            data-title="ŸÖÿ≥ÿßÿπÿØ Ÿàÿßÿ≤ŸÜ ÿßŸÑÿ∞ŸÉŸä"
            data-greeting="ÿ£ŸáŸÑÿßŸã Ÿàÿ≥ŸáŸÑÿßŸã ÿ®ŸÉ ŸÅŸä Ÿàÿßÿ≤ŸÜ! ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ÿßŸÑŸäŸàŸÖÿü"
            data-placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ ŸáŸÜÿß...">
    </script>

    <script>
        // Console output capture
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üìù';
            consoleOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };
        
        // Status update functions
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }
        
        // Test functions
        function testWidgetExists() {
            console.log('Testing if widget exists...');
            
            if (window.SAIAWidgetLoader) {
                console.log('‚úÖ SAIAWidgetLoader found');
                updateStatus('script-status', 'Widget loader loaded successfully', 'success');
            } else {
                console.error('‚ùå SAIAWidgetLoader not found');
                updateStatus('script-status', 'Widget loader failed to load', 'error');
            }
            
            if (window.saia) {
                console.log('‚úÖ window.saia function found');
            } else {
                console.error('‚ùå window.saia function not found');
            }
            
            if (window.SAIAWidget) {
                console.log('‚úÖ SAIAWidget class found');
            } else {
                console.log('‚ö†Ô∏è SAIAWidget class not loaded yet');
            }
        }
        
        function testWidgetVisible() {
            console.log('Testing widget visibility...');
            
            const widgetElements = document.querySelectorAll('[class*="saia"], [id*="saia"], [class*="widget"], [id*="widget"]');
            console.log(`Found ${widgetElements.length} potential widget elements`);
            
            widgetElements.forEach((el, index) => {
                console.log(`Element ${index + 1}: ${el.tagName} - ${el.className} - ${el.id}`);
            });
            
            if (widgetElements.length === 0) {
                updateStatus('widget-status', 'No widget elements found in DOM', 'warning');
            } else {
                updateStatus('widget-status', `Found ${widgetElements.length} widget elements`, 'success');
            }
        }
        
        async function testAPIConnection() {
            console.log('Testing API connection...');
            
            try {
                const response = await fetch('http://127.0.0.1:8000/api/widget/config/wazen/');
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ API connection successful');
                    console.log('API Response:', JSON.stringify(data, null, 2));
                } else {
                    console.error(`‚ùå API connection failed: ${response.status}`);
                }
            } catch (error) {
                console.error(`‚ùå API connection error: ${error.message}`);
            }
        }
        
        function forceShowWidget() {
            console.log('Attempting to force show widget...');
            
            if (window.saia) {
                try {
                    window.saia('show');
                    console.log('‚úÖ Called saia("show")');
                } catch (error) {
                    console.error(`‚ùå Error calling saia("show"): ${error.message}`);
                }
            }
            
            if (window.SAIAWidgetLoader && window.SAIAWidgetLoader.widget) {
                try {
                    window.SAIAWidgetLoader.widget.show();
                    console.log('‚úÖ Called widget.show()');
                } catch (error) {
                    console.error(`‚ùå Error calling widget.show(): ${error.message}`);
                }
            }
        }
        
        // Event listeners
        window.addEventListener('saia-widget-ready', function() {
            console.log('üéâ SAIA Widget Ready event fired!');
            updateStatus('init-status', 'Widget initialized successfully', 'success');
            testWidgetVisible();
        });
        
        window.addEventListener('saia-widget-loaded', function() {
            console.log('üì¶ SAIA Widget Loaded event fired!');
        });
        
        window.addEventListener('saia-widget-opened', function() {
            console.log('üìñ SAIA Widget Opened event fired!');
        });
        
        window.addEventListener('error', function(event) {
            console.error(`Global error: ${event.error?.message || event.message}`);
        });
        
        // Initialize debugging
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Debug page loaded');
            console.log('DOM ready, starting tests...');
            
            setTimeout(() => {
                testWidgetExists();
                testWidgetVisible();
            }, 1000);
            
            setTimeout(() => {
                testAPIConnection();
            }, 2000);
        });
        
        // Check every 5 seconds
        setInterval(() => {
            if (!window.SAIAWidgetLoader || !window.SAIAWidgetLoader.widget) {
                console.log('‚è∞ Widget still not initialized...');
            }
        }, 5000);
    </script>
</body>
</html>
